{% extends "base.html" %}

{% block title %}Chess Game{% endblock %}

{% block content %}
<div class="game-container">
    <div class="side-panel">
        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="stat-item wins">
                <span class="stat-icon">üèÜ</span>
                <span class="stat-value" id="wins-count">0</span>
                <span class="stat-label">Wins</span>
            </div>
            <div class="stat-item losses">
                <span class="stat-icon">üíî</span>
                <span class="stat-value" id="losses-count">0</span>
                <span class="stat-label">Losses</span>
            </div>
            <div class="stat-item streak">
                <span class="stat-icon">üî•</span>
                <span class="stat-value" id="streak-count">0</span>
                <span class="stat-label">Streak</span>
            </div>
        </div>

        <!-- Game Timer -->
        <div class="timer-section">
            <div class="timer-display">
                <div class="timer white-timer" id="white-timer">
                    <span class="timer-label">White</span>
                    <span class="timer-value">10:00</span>
                </div>
                <div class="timer black-timer" id="black-timer">
                    <span class="timer-label">Black</span>
                    <span class="timer-value">10:00</span>
                </div>
            </div>
        </div>

        <div class="status-section">
            <h2>Game Status</h2>
            <div id="status-message" class="status-message {{ 'check' if game.board.is_in_check(game.current_turn) else '' }}">
                {{ game.status_message }}
            </div>
            <div id="turn-indicator" class="turn-indicator">
                Current Turn: <span class="turn-color {{ game.current_turn }}">{{ game.current_turn.capitalize() }}</span>
            </div>
        </div>

        <div class="move-history-section">
            <h3>Move History</h3>
            <div id="move-history" class="move-history">
                <p class="no-moves">No moves yet</p>
            </div>
        </div>

        <div class="captured-pieces-section">
            <h3>Captured Pieces</h3>
            <div class="captured-white">
                <strong>White captured:</strong>
                <div class="captured-list">
                    {% for piece in game.captured_pieces.white %}
                        <span class="captured-piece">{{ piece.symbol if piece.symbol else '?' }}</span>
                    {% endfor %}
                    {% if not game.captured_pieces.white %}
                        <span class="none">None</span>
                    {% endif %}
                </div>
            </div>
            <div class="captured-black">
                <strong>Black captured:</strong>
                <div class="captured-list">
                    {% for piece in game.captured_pieces.black %}
                        <span class="captured-piece">{{ piece.symbol if piece.symbol else '?' }}</span>
                    {% endfor %}
                    {% if not game.captured_pieces.black %}
                        <span class="none">None</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="game-controls">
            <div class="control-row">
                <button id="undo-btn" class="btn btn-secondary" title="Undo Last Move">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="1 4 1 10 7 10"/>
                        <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                    </svg>
                    Undo
                </button>
                <button id="flip-board-btn" class="btn btn-secondary" title="Flip Board">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="17 1 21 5 17 9"/>
                        <path d="M3 11V9a4 4 0 0 1 4-4h14"/>
                        <polyline points="7 23 3 19 7 15"/>
                        <path d="M21 13v2a4 4 0 0 1-4 4H3"/>
                    </svg>
                    Flip
                </button>
            </div>
            <button id="resign-btn" class="btn btn-danger">Resign Game</button>
        </div>
    </div>

    <div class="board-container">
        <div class="chessboard" id="chessboard"
             data-current-turn="{{ game.current_turn }}"
             data-game-over="{{ game.game_over|tojson }}"
             data-debug="{{ 'true' if debug_ui else 'false' }}">
            {% for row in range(8) %}
                {% for col in range(8) %}
                    {% set piece = game.board.get_piece(row, col) %}
                    {% set is_light = (row + col) % 2 == 0 %}
                    <div class="square {{ 'light' if is_light else 'dark' }}"
                         data-row="{{ row }}"
                         data-col="{{ col }}">
                        {% if piece %}
                            <div class="piece {{ piece.color }} {{ piece.__class__.__name__.lower() }}"
                                 data-piece-type="{{ piece.__class__.__name__.lower() }}"
                                 data-piece-color="{{ piece.color }}"></div>
                        {% endif %}
                        {% if col == 0 %}
                            <span class="rank-label">{{ 8 - row }}</span>
                        {% endif %}
                        {% if row == 7 %}
                            <span class="file-label">{{ 'abcdefgh'[col] }}</span>
                        {% endif %}
                    </div>
                {% endfor %}
            {% endfor %}
        </div>
    </div>
</div>

<div id="promotion-modal" class="modal" style="display: none;">
    <div class="modal-content promotion-modal-content">
        <h2>Choose Promotion Piece</h2>
        <p>Select which piece you want to promote your pawn to:</p>
        <div class="promotion-choices">
            <button class="promotion-btn" data-piece="queen">
                <div class="promotion-piece piece white queen"></div>
                <span>Queen</span>
            </button>
            <button class="promotion-btn" data-piece="rook">
                <div class="promotion-piece piece white rook"></div>
                <span>Rook</span>
            </button>
            <button class="promotion-btn" data-piece="bishop">
                <div class="promotion-piece piece white bishop"></div>
                <span>Bishop</span>
            </button>
            <button class="promotion-btn" data-piece="knight">
                <div class="promotion-piece piece white knight"></div>
                <span>Knight</span>
            </button>
        </div>
    </div>
</div>

<div id="game-over-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <h2 id="game-over-title">Game Over</h2>
        <p id="game-over-message"></p>
        <button id="new-game-modal-btn" class="btn">Start New Game</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/chess.js', v=config['ASSET_VERSION']) }}"></script>
{% endblock %}
